# Sample of a microservice based application architecture

### Overview of the application
If you want to ship a new software quickly and you don't have much resources in terms of finance and engineers, monolithic architecture is the way to go.

Think of Monolithic architecture as "everything together as one". It is a traditional way of building softwares from scratch as a single unit. It has a number of pros like ease of development and deployment, non-complex testing,  and is applicable in a small and medium codebase.

However, there comes a time when the codebase grows bigger and updates to a part of the codebase leads to a break in other parts because the application is tightly coupled together.

This is the problem that microservice architectural style solves.

Microservice architecture is a software architectural style that structure applications as a collection of loosely connected services, making it easier to build and scale applications.

In this repo, I built a sample of a microservice based application architecture with Laravel Lumen framework which can be cloned and used for your project.

It consists of two services, namely: PostService and CommentService and a API gateway.

The API Gateway is responsible for user authentication and it also routes requests to the appropriate microservice which in turn returns the appropriate response.

A direct access to any of the services is restricted through the middleware `ApiToken`.

The API Gateway uses an Oauth2 token based authentication for the microservices built with Laravel Passport.

### Architecture of the application

Attached below is a pictorial architecture of the application:

## Proposed Architecture

![architecture](microservice-architecture.png)

### General installation guides

#### Step 1: Clone the repository

```bash
git clone https://github.com/ayodeleoniosun/lumen-microservice.git
```

#### Step 2: Switch to the repo folder

```bash
cd lumen-microservice
```

#### Step 3: Setup environment variable for each service

- Copy `.env.example` to `.env` i.e `cp .env.example .env`

#### Step 4: Navigate to each service (including apigateway) and run 

```bash
composer install
```

#### Step 5: Navigate back to the root directory and build the docker images

```bash
cd ../../
docker-compose build --no-cache
```
#### Step 6: Spring up a docker container in detached mode

```bash
docker-compose up -d --force-recreate
```

#### Step 7: Run database migrations alongside the seeders

```bash
docker-compose exec apigateway php artisan migrate:fresh --seed
docker-compose exec postservice php artisan migrate:fresh --seed
docker-compose exec commentservice php artisan migrate:fresh --seed
```

#### Step 8: Generate Oauth Secret

```bash
docker-compose exec apigateway php artisan passport:install
```  

Two credentials would be generated, one for `personal access client` and the other for `password grant client`.

Copy the Client ID and the secret of the latter and update the `OAUTH_CLIENT_ID` and `OAUTH_CLIENT_SECRET` in the `env` of `apigateway`.

#### Step 9: Generate Post and Comment Service secret
This secret is a random alphanumeric string which can be generated by any random string generator. I used [this website](http://www.unit-conversion.info/texttools/random-string-generator/)
to generate the secrets.

However, ensure that the length of the string is `32` and separate strings are generated for `apigateway`, `postservice` and `commentservice`

After generating the random strings, ensure you update the `POST_SERVICE_SECRET` and the `COMMENT_SERVICE_SECRET` in the `.env` of the `apigateway`  and also the `.env` for Post and Comment Service.

#### Step 10: Generate a new application key
Repeat the same process to generate application key and update the `APP_KEY` in the `.env` file of `apigateway`, `postservice` and `commentservice` with each generated strings.

#### Step 11: Testing
Run the following command to run tests:

```bash
docker-compose exec apigateway ./vendor/bin/phpunit
docker-compose exec postservice ./vendor/bin/phpunit
docker-compose exec commentservice ./vendor/bin/phpunit
```

### API Documentation

The Postman API collection is available [Here](postman_collection.json). <br/>